<!DOCTYPE html>
<html lang="en">    
    <head>  
        <meta charset="UTF-8">
        <title>ESP32 Wifi Scanner AP Mode</title>
        <style>
            body{
                font-family: Arial, Helvetica, sans-serif;
                margin: 20px;
                background: #f0f0f0;
            }
            h2{
                color: #333;
            }
            button{
                padding: 10px 16px;
                font-size: 16px; 
                cursor: pointer;
                background-color: #0078ff;
                color: white;
                border: none;
                border-radius: 5px;
            }
            button:hover{
                background-color: #005fcc;
            }
            button:disabled{
                background-color: #999;
                cursor: not-allowed;
                opacity: 0.6;
            }

            #status {
                margin-top: 10px;
                font-weight: bold;
                color: #444;
            }
            table{
                margin-top: 20px;
                width: 100%;
                border-collapse: collapse;
                background: white;
            }
            th, td{
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th{
                background-color: #0078ff;
                color: white;
            }
            #ssidinput, #wifiPassword {
                padding: 8px;
                width: 200px;
                box-sizing: border-box;
            }

        </style>
    </head>

    <body>
        <h2>ESP32 Wifi Scanner AP Mode</h2>
        <!-- menjalankan fungsi startscan yang didefinisikan di bawah -->
        <button onclick="startScan()">Scan Wifi</button>
        <div id="status">Status: idle</div>
        
        <table id="resultTable">
            <thead>
                <tr>
                    <th>SSID</th>
                    <th>RSSI</th>
                    <th>Channel</th>
                    <th>Auth</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Connect to Wifi (please klik ssid to connect)</h3>
        <div id="connectBox" style="display:none;">
            <!-- <p>SSID: <b id="selectedSSID"></b></p> -->
            <input id="ssidinput" readonly>
            <input type="password" id="wifiPassword" placeholder="Enter Wifi Password" style="display: none;">
            <br><br>
            <button onclick="connectWifi()">Connect</button>
            
            <div id="connectStatus"></div>
        </div>


        <!-- skrip -->
        <script>
        function startScan(){
            const btn = document.querySelector("button");
            btn.disabled = true; // menonaktifkan tombol selama pemindaian
            document.getElementById("status").innerText = "Status: Scanning...";

            fetch("/scan")
                .then(() =>pollResults());
                // .then(res => res.text())
                // .then(text => {
                //     console.log("Scan triggered:", text);
                //     waitScanResults();
                // });
        }

        function waitScanResults(){
            setTimeout(pollResults, 1000);            
        }

        function pollResults(){
            fetch("/scan_results")
                .then(res => res.json())
                .then(data =>{
                    console.log("Scan results:", data);
                    // jika belum ada hasil
                    if (data.status === "scan in progress") {
                        document.getElementById("status").innerText = "Status: scanning in progress...";
                        return waitScanResults();
                    }
                    
                    // jika ada hasil
                    if (data.status !== "scan completed") {
                        document.getElementById("status").innerText = "Status: wifi busy, retrying...";
                        return waitScanResults();
                    }

                    document.getElementById("status").innerText = "Status: scan completed (" + data.ap_count + "AP)";

                    document.querySelector("button").disabled = false; // mengaktifkan kembali tombol setelah pemindaian selesai
                    const tbody = document.querySelector("#resultTable tbody");
                    tbody.innerHTML = "";

                    data.aps.forEach( ap => {
                        const tr = document.createElement("tr");

                        tr.innerHTML = `
                            <td>${ap.ssid || "(hidden)"}</td>
                            <td>${ap.rssi}</td>
                            <td>${ap.channel}</td>
                            <td>${ap.authmode}</td>
                        `;

                        tr.addEventListener("click", () => {
                            selectSSID(ap.ssid, ap.authmode);
                        });

                        tbody.appendChild(tr);

                        // const row = ` 
                        //     <tr onclick="selectSSID('${ap.ssid}', '${ap.authmode}')" > 
                        //         <td>${ap.ssid || "(hidden)"}</td> 
                        //         <td>${ap.rssi}</td>
                        //         <td>${ap.channel}</td>
                        //         <td>${ap.authmode}</td>
                        //     </tr>
                        // `; // menambahkan event onclick pada baris
                        // tbody.innerHTML += row;
                    });
                })
                .catch(err =>{
                    console.error("error:", err);
                    document.getElementById("status").innerText = "error fetching results"; // masih muncul error meskipun scan berhasil
                });
        }

        let selectedSSID = "";
        let selectedAuthmode = "";

        function selectSSID(ssid, authmode){
            selectedSSID = ssid;
            selectedAuthmode = authmode;
            // menampilkan kotak koneksi
            document.getElementById("connectBox").style.display = "block";
            // menampilkan ssid yang dipilih
            document.getElementById("ssidinput").value = ssid || "(hidden)";

            const passwordInput = document.getElementById("wifiPassword");
            if (authmode === "OPEN") {
                document.getElementById("wifiPassword").style.display = "none";
            } else {
                document.getElementById("wifiPassword").style.display = "block";
            }

            document.getElementById("connectStatus").innerText = 
                "selected SSID: " + (ssid || "(hidden)");
        }

        function connectWifi(){
            const password = document.getElementById("wifiPassword").value;
            const ssid = document.getElementById("ssidinput").value;
            
            document.getElementById("connectStatus").innerText = "Connecting to ";

            fetch("/connect_wifi", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    ssid: ssid,
                    password: password
                })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById("connectStatus").innerText = data.status;
            })
            .catch(err => {
                console.error("error:", err);
                document.getElementById("connectStatus").innerText = "error connecting to wifi";
            });
        }

        // function fetchResults(){
        //     fetch("/scan_results")
        //         .then(res => res.json())
        //         .then(data =>{
        //             // jika belum ada hasil
        //             if (data.status === "no_result") {
        //                 document.getElementById("status").innerText = "Status: waiting for scan result...";
        //                 return waitScanResults();
        //             }
        //             document.getElementById("status").innerText = "Status: scan finished (" + data.length + "AP)";

        //             const tbody = document.querySelector("#resultTable tbody");
        //             tbody.innerHTML = "";

        //             data.forEach( ap => {
        //                 const row = `
        //                     <tr>
        //                         <td>${ap.ssid}</td>
        //                         <td>${ap.rssi}</td>
        //                         <td>${ap.channel}</td>
        //                         <td>${ap.authmode}</td>
        //                     </tr>
        //                 `;
        //                 tbody.innerHTML += row;
        //             });
        //         })
        //         .catch(err =>{
        //             console.error("error:", err);
        //             document.getElementById("status").innerText = "error fetching results";
        //         });
        // }
        </script>         

    </body>
</html>